<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Dynasties Duel Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e2e8f0;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  padding: 12px;
  background: #1e293b;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
}

#difficulty {
  background: #334155;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
}

#board {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 12px;
  padding: 10px;
}

.row {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.card {
  width: 110px;
  height: 160px;
  background: #1e293b;
  border: 2px solid #475569;
  border-radius: 10px;
  padding: 8px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  font-size: 14px;
  cursor: pointer;
}

.card.blocked {
  opacity: 0.3;
  cursor: default;
}

.card.selected {
  border-color: #facc15;
  box-shadow: 0 0 10px #facc15;
}

#panel {
  background: #1e293b;
  padding: 12px;
  border-top: 2px solid #334155;
}

#actions button {
  width: 48%;
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  color: white;
}

#buildBtn { background: #3b82f6; }
#discardBtn { background: #64748b; }

#log {
  margin-top: 10px;
  font-size: 14px;
  max-height: 80px;
  overflow-y: auto;
}
</style>
</head>

<body>

<header>
  <div>Dynasties Duel</div>
  <select id="difficulty">
    <option value="easy">Facile</option>
    <option value="normal" selected>Normal</option>
    <option value="hard">Expert</option>
  </select>
</header>

<div id="board"></div>

<div id="panel">
  <div id="details">Sélectionne une carte.</div>
  <div id="actions" style="display:flex;justify-content:space-between;margin-top:10px;">
    <button id="buildBtn" disabled>Construire</button>
    <button id="discardBtn" disabled>Défausser</button>
  </div>
  <div id="log"></div>
</div>

<script>
/* --- CARTES --- */
const cards = [
  {id:0, name:"Bois", type:"ressource", cost:{}, effect:{wood:1}},
  {id:1, name:"Argile", type:"ressource", cost:{}, effect:{clay:1}},
  {id:2, name:"Pierre", type:"ressource", cost:{}, effect:{stone:1}},
  {id:3, name:"Caserne", type:"militaire", cost:{clay:1}, effect:{military:1}},
  {id:4, name:"Bibliothèque", type:"science", cost:{wood:1}, effect:{science:"compas"}},
  {id:5, name:"Temple", type:"civique", cost:{stone:1}, effect:{victory:3}}
];

/* --- PYRAMIDE --- */
const layout = [
  [5],
  [3,4],
  [0,1,2]
];

/* --- ÉTAT --- */
let human = {gold:6, wood:0, clay:0, stone:0, military:0, science:[], victory:0};
let ai =    {gold:6, wood:0, clay:0, stone:0, military:0, science:[], victory:0};

let taken = [false,false,false,false,false,false];
let selected = null;
let turn = "human";

/* --- UI --- */
function log(msg){
  document.getElementById("log").innerHTML = msg + "<br>" + document.getElementById("log").innerHTML;
}

function render(){
  const board = document.getElementById("board");
  board.innerHTML = "";

  layout.forEach((row,r)=>{
    const div = document.createElement("div");
    div.className = "row";

    row.forEach((id,c)=>{
      const card = cards[id];
      const el = document.createElement("div");
      el.className = "card";

      if(taken[id]){ el.style.visibility="hidden"; div.appendChild(el); return; }

      if(isBlocked(r,c)) el.classList.add("blocked");
      if(selected===id) el.classList.add("selected");

      el.innerHTML = `
        <div><b>${card.name}</b></div>
        <div>Type: ${card.type}</div>
        <div>Coût: ${formatCost(card.cost)}</div>
        <div>Effet: ${formatEffect(card.effect)}</div>
      `;

      el.onclick = ()=>{
        if(turn!=="human") return;
        if(isBlocked(r,c)) return;
        selected = id;
        updateButtons();
        render();
      };

      div.appendChild(el);
    });

    board.appendChild(div);
  });
}

function formatCost(c){
  let out=[];
  if(c.gold) out.push(c.gold+" or");
  if(c.wood) out.push(c.wood+" bois");
  if(c.clay) out.push(c.clay+" argile");
  if(c.stone) out.push(c.stone+" pierre");
  return out.length?out.join(", "):"0";
}

function formatEffect(e){
  let out=[];
  if(e.wood) out.push("+1 bois");
  if(e.clay) out.push("+1 argile");
  if(e.stone) out.push("+1 pierre");
  if(e.military) out.push("+1 militaire");
  if(e.victory) out.push("+"+e.victory+" PV");
  if(e.science) out.push("science");
  return out.join(", ");
}

/* --- BLOQUAGE --- */
function isBlocked(r,c){
  if(r===0) return false;
  const above = layout[r-1];
  if(r===2){
    if(c===0) return !taken[above[0]];
    if(c===1) return !taken[above[0]] || !taken[above[1]];
    if(c===2) return !taken[above[1]];
  }
  if(r===1){
    return !taken[above[0]];
  }
  return false;
}

/* --- ACTIONS --- */
function canPay(p,c){
  if(c.gold && p.gold<c.gold) return false;
  if(c.wood && p.wood<c.wood) return false;
  if(c.clay && p.clay<c.clay) return false;
  if(c.stone && p.stone<c.stone) return false;
  return true;
}

function apply(p,e){
  if(e.wood) p.wood++;
  if(e.clay) p.clay++;
  if(e.stone) p.stone++;
  if(e.military) p.military++;
  if(e.victory) p.victory+=e.victory;
  if(e.science) p.science.push(e.science);
}

function build(){
  if(selected===null) return;
  const card = cards[selected];
  if(!canPay(human,card.cost)) return;

  pay(human,card.cost);
  apply(human,card.effect);
  taken[selected]=true;
  log("Tu construis "+card.name);
  selected=null;
  updateButtons();
  render();
  setTimeout(aiTurn,600);
}

function discard(){
  if(selected===null) return;
  taken[selected]=true;
  human.gold+=2;
  log("Tu défausses et gagnes 2 or");
  selected=null;
  updateButtons();
  render();
  setTimeout(aiTurn,600);
}

function pay(p,c){
  if(c.gold) p.gold-=c.gold;
  if(c.wood) p.wood-=c.wood;
  if(c.clay) p.clay-=c.clay;
  if(c.stone) p.stone-=c.stone;
}

function updateButtons(){
  const b = document.getElementById("buildBtn");
  const d = document.getElementById("discardBtn");

  if(selected===null){
    b.disabled = true;
    d.disabled = true;
    return;
  }

  const card = cards[selected];
  b.disabled = !canPay(human,card.cost);
  d.disabled = false;
}

/* --- IA --- */
function aiTurn(){
  turn="ai";
  const diff = document.getElementById("difficulty").value;

  const choices = getAccessibleCards();
  if(choices.length===0){ turn="human"; return; }

  let best=null, bestScore=-999;

  choices.forEach(id=>{
    const card = cards[id];
    let s = scoreCard(card,ai,diff);
    if(s>bestScore){ bestScore=s; best=id; }
  });

  const card = cards[best];
  if(canPay(ai,card.cost)){
    pay(ai,card.cost);
    apply(ai,card.effect);
    log("IA construit "+card.name);
  } else {
    ai.gold+=2;
    log("IA défausse "+card.name);
  }

  taken[best]=true;
  turn="human";
  render();
}

function getAccessibleCards(){
  let out=[];
  layout.forEach((row,r)=>{
    row.forEach((id,c)=>{
      if(!taken[id] && !isBlocked(r,c)) out.push(id);
    });
  });
  return out;
}

function scoreCard(card,p,diff){
  let s=0;
  if(card.type==="ressource") s+=2;
  if(card.type==="militaire") s+=4;
  if(card.type==="science") s+=5;
  if(card.type==="civique") s+=card.effect.victory;

  if(!canPay(p,card.cost)) s-=100;

  if(diff==="easy") s+=Math.random()*2-1;
  if(diff==="hard" && card.type==="science") s+=3;

  return s;
}

/* --- INIT --- */
document.getElementById("buildBtn").onclick = build;
document.getElementById("discardBtn").onclick = discard;

render();
</script>

</body>
</html>
