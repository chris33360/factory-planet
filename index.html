<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Planet - Tech Bonuses</title>
    <style>
        :root { 
            --bg: #0f0f0f; --panel: #1a1a1a; --accent: #ff9800; 
            --iron: #3d3d3d; --copper: #5d2a1c; --quartz: #004d40; --oil: #000000;
            --power: #4caf50; --danger: #f44336; 
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; display: flex; }
        
        /* HUD SUPERIEUR */
        #hud { position: fixed; top: 0; left: 120px; width: calc(100% - 270px); background: rgba(26,26,26,0.95); z-index: 100; padding: 8px; border-bottom: 1px solid #333; box-sizing: border-box; }
        .res-grid { font-size: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .res-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .flux { font-size: 8px; opacity: 0.8; }
        .gain { color: var(--power); } .loss { color: var(--danger); }
        
        /* MENU CONSTRUCTION (GAUCHE) */
        #controls { width: 120px; height: 100vh; background: var(--panel); border-right: 1px solid #333; z-index: 101; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex-shrink: 0; }
        #controls h3 { font-size: 11px; margin: 0 0 5px 0; color: #888; text-align: center; text-transform: uppercase; }
        button.build-btn { background: #2a2a2a; color: white; border: 1px solid #444; padding: 8px 4px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: 0.2s; text-align: left; }
        button.build-btn span { display: block; font-size: 8px; color: #aaa; margin-top: 2px; }
        button.active { border-color: var(--accent); background: #3d2a00; }
        
        /* TECH TREE (DROITE) */
        #tech-tree { width: 150px; height: 100vh; background: var(--panel); border-left: 1px solid #333; z-index: 101; padding: 10px; box-sizing: border-box; overflow-y: auto; flex-shrink: 0; }
        .tech-item { background: #222; border: 1px solid #444; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 10px; opacity: 0.4; border-left: 3px solid transparent; }
        .tech-item.current { opacity: 1; border-color: var(--accent); border-left-color: var(--accent); background: #2a2010; }
        .tech-item.unlocked { opacity: 1; border-color: var(--power); border-left-color: var(--power); background: #1b2e1b; }
        .tech-item h4 { margin: 0 0 2px 0; font-size: 11px; color: var(--accent); }
        .tech-item .bonus { color: #4caf50; font-weight: bold; font-size: 9px; margin-bottom: 5px; display: block; }
        .tech-item button { width: 100%; background: var(--accent); color: black; border: none; padding: 4px; border-radius: 2px; font-weight: bold; font-size: 9px; margin-top: 5px; cursor: pointer; }
        .tech-item button:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* ZONE DE JEU */
        #viewport { flex-grow: 1; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #080808; position: relative; }
        #grid { display: grid; grid-template-columns: repeat(45, 35px); grid-template-rows: repeat(22, 35px); gap: 1px; }
        .cell { width: 35px; height: 35px; background: #141414; border: 1px solid #1f1f1f; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
        .cell.iron { background-color: var(--iron); }
        .cell.copper { background-color: var(--copper); }
        .cell.quartz { background-color: var(--quartz); }
        .cell.oil { background-color: var(--oil); }
        .status-icon { position: absolute; font-size: 10px; top: 0; right: 0; }

        #power-bar { font-size: 10px; font-weight: bold; background: #000; padding: 4px; border-radius: 3px; margin-top: 6px; text-align: center; border: 1px solid #222; }
        .night-mode #viewport { background: #050510 !important; }
        .night-mode #grid { filter: brightness(0.7); }
    </style>
</head>
<body id="main-body">

<div id="controls">
    <h3>üî® B√¢tir</h3>
    <button class="build-btn" id="btn-miner" onclick="setMode('miner')">‚õèÔ∏è Mineur <span>50 Fe</span></button>
    <button class="build-btn" id="btn-solar" onclick="setMode('solar')">‚òÄÔ∏è Solaire <span>40 Fe, 20 Cu</span></button>
    <button class="build-btn" id="btn-fuel" onclick="setMode('fuel')">‚ö° G√©n√© <span>150 Fe, 80 Cu</span></button>
    <button class="build-btn" id="btn-glass_factory" onclick="setMode('glass_factory')">üè∫ Verre <span>80 Fe, 40 Qz</span></button>
    <button class="build-btn" id="btn-motor_factory" onclick="setMode('motor_factory')">‚öôÔ∏è Moteur <span>120 Fe, 60 Cu</span></button>
    <button class="build-btn" id="btn-cable_factory" onclick="setMode('cable_factory')">üîå C√¢ble <span>60 Fe, 40 Cu</span></button>
    <div style="flex-grow: 1;"></div>
    <button class="build-btn" id="btn-recycle" onclick="setMode('recycle')" style="color:var(--danger); border-color: #522;">‚ôªÔ∏è SUPPR</button>
</div>

<div id="hud">
    <div class="res-grid">
        <div class="res-item" style="color:#ddd">Fe: <span id="res-iron">0</span> <span id="flux-iron" class="flux"></span></div>
        <div class="res-item" style="color:#ffccbc">Cu: <span id="res-copper">0</span> <span id="flux-copper" class="flux"></span></div>
        <div class="res-item" style="color:#b2dfdb">Qz: <span id="res-quartz">0</span> <span id="flux-quartz" class="flux"></span></div>
        <div class="res-item" style="color:#fff">Oil: <span id="res-oil">0</span> <span id="flux-oil" class="flux"></span></div>
        <div class="res-item" style="color:#e1f5fe">Gls: <span id="res-glass">0</span> <span id="flux-glass" class="flux"></span></div>
        <div class="res-item" style="color:#ffe0b2">Mot: <span id="res-motor">0</span> <span id="flux-motor" class="flux"></span></div>
        <div class="res-item" style="color:#f0f4c3">Cab: <span id="res-cable">0</span> <span id="flux-cable" class="flux"></span></div>
        <div id="cycle-info" style="text-align: right; font-weight: bold;">‚òÄÔ∏è</div>
    </div>
    <div id="power-bar">‚ö° <span id="p-cons">0</span>W / <span id="p-prod">0</span>W</div>
</div>

<div id="viewport">
    <div id="grid"></div>
</div>

<div id="tech-tree">
    <h3 style="font-size: 12px; margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px;">üöÄ TECH TREE</h3>
    <div id="tier-list"></div>
</div>

<script>
    let state = {
        res: { iron: 300, copper: 150, quartz: 50, oil: 0, glass: 0, motor: 0, cable: 0 },
        tier: 1, mode: null, offset: { x: 0, y: 0 }, time: 0
    };

    const TECHS = [
        { id: 1, name: "Base", bonus: "+0%", cost: {}, desc: "Extraction primaire." },
        { id: 2, name: "Industrie", bonus: "+20% Production extracteurs", cost: { iron: 1000, motor: 20 }, },
        { id: 3, name: "√âlectronique", bonus: "+50% Prod", cost: { iron: 2500, cable: 100, glass: 50 }, desc: "Circuits avanc√©s." },
        { id: 4, name: "√àre Spatiale", bonus: "+100% Prod", cost: { iron: 10000, motor: 500, cable: 500, glass: 200 }, desc: "Conqu√™te orbitale." },
        { id: 4, name: "Exploration Spatiale", bonus: "+100% Prod", cost: { iron: 10000, motor: 500, cable: 500, glass: 200 }, desc: "Conqu√™te orbitale." }
    ];

    let gridData = [];
    const COLS = 45, ROWS = 22;
    const COSTS = { 
        miner: { iron: 50 }, solar: { iron: 40, copper: 20 }, fuel: { iron: 150, copper: 80 },
        glass_factory: { iron: 80, quartz: 40 }, motor_factory: { iron: 120, copper: 60 }, cable_factory: { iron: 60, copper: 40 }
    };

    function init() {
        const gridEl = document.getElementById('grid');
        for (let i = 0; i < COLS * ROWS; i++) {
            let r = Math.random();
            let type = (r > 0.98) ? 'oil' : (r > 0.96) ? 'quartz' : (r > 0.93) ? 'copper' : (r > 0.88) ? 'iron' : 'empty';
            gridData.push({ id: i, type, build: null });
        }
        gridData.forEach((c, i) => {
            let cell = document.createElement('div');
            cell.className = `cell ${c.type}`;
            cell.id = 'c-' + i;
            cell.onclick = () => handleCellClick(i);
            gridEl.appendChild(cell);
        });
        updateTechTree();
    }

    function updateTechTree() {
        const list = document.getElementById('tier-list');
        list.innerHTML = "";
        TECHS.forEach(t => {
            let div = document.createElement('div');
            div.className = `tech-item ${state.tier === t.id ? 'current' : ''} ${state.tier > t.id ? 'unlocked' : ''}`;
            let costsHtml = Object.entries(t.cost).map(([res, val]) => `<div>‚Ä¢ ${val} ${res}</div>`).join("");
            let canAfford = Object.entries(t.cost).every(([res, val]) => state.res[res] >= val);
            div.innerHTML = `
                <h4>TIER ${t.id}</h4>
                <div class="bonus">${t.name} : ${t.bonus}</div>
                <div style="font-size:8px; color:#aaa; margin-bottom:5px;">${costsHtml}</div>
                ${state.tier === t.id - 1 ? `<button onclick="upgradeTier(${t.id})" ${!canAfford ? 'disabled' : ''}>RECHERCHER</button>` : ''}
            `;
            list.appendChild(div);
        });
    }

    function upgradeTier(id) {
        let tech = TECHS.find(t => t.id === id);
        Object.entries(tech.cost).forEach(([res, val]) => state.res[res] -= val);
        state.tier = id;
        updateTechTree();
    }

    function setMode(m) {
        state.mode = (state.mode === m) ? null : m;
        document.querySelectorAll('.build-btn').forEach(b => b.classList.remove('active'));
        if(state.mode) document.getElementById('btn-' + m).classList.add('active');
    }

    function handleCellClick(i) {
        let cell = gridData[i];
        if (state.mode === 'recycle' && cell.build) { cell.build = null; updateCellUI(i); return; }
        if (cell.build || !state.mode) return;
        let cost = COSTS[state.mode];
        if (cost && Object.keys(cost).every(r => state.res[r] >= cost[r])) {
            if (state.mode === 'miner' && cell.type === 'empty') return;
            Object.keys(cost).forEach(r => state.res[r] -= cost[r]);
            cell.build = state.mode; updateCellUI(i);
        }
    }

    function updateCellUI(i, status = null) {
        let c = gridData[i], el = document.getElementById('c-' + i);
        if (c.build) {
            const icons = { miner: '‚õèÔ∏è', solar: '‚òÄÔ∏è', fuel: '‚ö°', glass_factory: 'üè∫', motor_factory: '‚öôÔ∏è', cable_factory: 'üîå' };
            el.innerHTML = icons[c.build] + (status ? `<span class="status-icon">${status}</span>` : '');
        } else { el.innerHTML = ""; }
    }

    setInterval(() => {
        state.time = (state.time + 1) % 60;
        const isNight = state.time >= 30;
        document.getElementById('main-body').className = isNight ? 'night-mode' : '';
        document.getElementById('cycle-info').innerHTML = isNight ? 'üåô' : '‚òÄÔ∏è';

        // Logique de bonus par Tier
        const bonuses = { 1: 1.0, 2: 1.2, 3: 1.5, 4: 2.0 };
        let speed = bonuses[state.tier];

        let solarProd = gridData.filter(c => c.build === 'solar').length * (15 * (isNight ? 0.3 : 1.0));
        let currentPower = solarProd;
        let oilCons = 0;
        
        gridData.filter(c => c.build === 'fuel').forEach(g => {
            if (state.res.oil >= 1) { state.res.oil -= 1; oilCons++; currentPower += 30; updateCellUI(gridData.indexOf(g)); }
            else { updateCellUI(gridData.indexOf(g), '‚ö†Ô∏è'); }
        });

        let powerReq = 0, gains = { iron: 0, copper: 0, quartz: 0, oil: 0, glass: 0, motor: 0, cable: 0 }, losses = { iron: 0, copper: 0, quartz: 0, oil: oilCons };

        gridData.forEach((c, idx) => {
            if(!c.build) return;
            let canWork = false;
            if(c.build === 'miner') { powerReq += 8; if(currentPower >= powerReq) { state.res[c.type] += speed; gains[c.type] += speed; canWork = true; } }
            else if(c.build === 'glass_factory') { powerReq += 10; if(currentPower >= powerReq && state.res.quartz >= 1) { state.res.quartz -= 1; losses.quartz++; state.res.glass += speed; gains.glass += speed; canWork = true; } }
            else if(c.build === 'motor_factory') { powerReq += 15; if(currentPower >= powerReq && state.res.iron >= 1 && state.res.copper >= 1) { state.res.iron -= 1; state.res.copper -= 1; losses.iron++; losses.copper++; state.res.motor += speed; gains.motor += speed; canWork = true; } }
            else if(c.build === 'cable_factory') { powerReq += 8; if(currentPower >= powerReq && state.res.copper >= 1) { state.res.copper -= 1; losses.copper++; state.res.cable += speed; gains.cable += speed; canWork = true; } }
            if(['miner','glass_factory','motor_factory','cable_factory'].includes(c.build)) updateCellUI(idx, canWork ? null : '‚ùå');
        });

        ['iron', 'copper', 'quartz', 'oil', 'glass', 'motor', 'cable'].forEach(r => {
            document.getElementById(`res-${r}`).innerText = Math.floor(state.res[r]);
            let net = gains[r] - (losses[r] || 0);
            let f = document.getElementById(`flux-${r}`);
            f.innerText = (net >= 0 ? "+" : "") + net.toFixed(1);
            f.className = "flux " + (net >= 0 ? "gain" : "loss");
        });

        document.getElementById('p-cons').innerText = Math.round(powerReq);
        document.getElementById('p-prod').innerText = Math.round(currentPower);
        document.getElementById('power-bar').style.color = currentPower < powerReq ? 'var(--danger)' : 'var(--power)';
        updateTechTree(); 
    }, 1000);

    let isDragging = false, lastMouse = { x: 0, y: 0 };
    window.onpointerdown = (e) => { 
        if(!e.target.closest('#tech-tree') && !e.target.closest('#controls') && !e.target.closest('#hud')) isDragging = true; 
        lastMouse = { x: e.clientX, y: e.clientY }; 
    };
    window.onpointerup = () => isDragging = false;
    window.onpointermove = (e) => {
        if (!isDragging) return;
        state.offset.x += e.clientX - lastMouse.x; state.offset.y += e.clientY - lastMouse.y;
        document.getElementById('grid').style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
        lastMouse = { x: e.clientX, y: e.clientY };
    };
    init();
</script>
</body>
</html>
