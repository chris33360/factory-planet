<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Planet - Meteor Hazard</title>
    <style>
        :root { 
            --bg: #0f0f0f; --panel: #1a1a1a; --accent: #ff9800; 
            --iron: #3d3d3d; --copper: #5d2a1c; --quartz: #004d40;
            --power: #4caf50; --danger: #f44336; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; }
        
        /* HUD & PANELS */
        #hud { position: fixed; top: 0; left: 120px; width: calc(100% - 270px); background: rgba(26,26,26,0.95); z-index: 100; padding: 6px; border-bottom: 1px solid #333; box-sizing: border-box; }
        .res-grid { font-size: 9px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .res-item { display: flex; align-items: center; gap: 3px; }
        .flux { font-size: 8px; opacity: 0.7; }
        .gain { color: var(--power); } .loss { color: var(--danger); }
        
        #controls { width: 120px; height: 100vh; background: var(--panel); border-right: 1px solid #333; z-index: 101; padding: 10px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; flex-shrink: 0; }
        button.build-btn { background: #2a2a2a; color: white; border: 1px solid #444; padding: 6px; border-radius: 4px; font-size: 9px; cursor: pointer; text-align: left; }
        button.active { border-color: var(--accent); background: #3d2a00; }
        
        #tech-tree { width: 150px; height: 100vh; background: var(--panel); border-left: 1px solid #333; z-index: 101; padding: 10px; font-size: 10px; flex-shrink: 0; }

        /* VIEWPORT & GRID */
        #viewport { flex-grow: 1; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #080808; position: relative; }
        #grid { display: grid; grid-template-columns: repeat(45, 35px); grid-template-rows: repeat(22, 35px); gap: 1px; }
        .cell { width: 35px; height: 35px; background: #141414; border: 1px solid #1f1f1f; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
        .cell.iron { background-color: var(--iron); }
        .cell.copper { background-color: var(--copper); }
        .cell.quartz { background-color: var(--quartz); }
        
        /* METEOR EFFECT */
        .cell.impact { background-color: #f44336 !important; animation: shake 0.5s infinite; border: 1px solid yellow; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, 1px); } }
        
        #alert { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; z-index: 1000; display: none; }

        #power-bar { font-size: 9px; font-weight: bold; background: #000; padding: 3px; border-radius: 3px; margin-top: 5px; text-align: center; border: 1px solid #222; }
    </style>
</head>
<body id="main-body">

<div id="alert">‚ö†Ô∏è ALERTE : M√âT√âORE EN APPROCHE ! ‚ö†Ô∏è</div>

<div id="controls">
    <h3 style="font-size: 10px; color:#888">üî® B√¢tir</h3>
    <button class="build-btn" id="btn-miner" onclick="setMode('miner')">‚õèÔ∏è Mineur <span>50 Fe</span></button>
    <button class="build-btn" id="btn-solar" onclick="setMode('solar')">‚òÄÔ∏è Solaire <span>40 Fe, 20 Cu</span></button>
    <button class="build-btn" id="btn-glass_factory" onclick="setMode('glass_factory')">üè∫ Verre <span>80 Fe, 40 Qz</span></button>
    <button class="build-btn" id="btn-motor_factory" onclick="setMode('motor_factory')">‚öôÔ∏è Moteur <span>120 Fe, 60 Cu</span></button>
    <button class="build-btn" id="btn-cable_factory" onclick="setMode('cable_factory')">üîå C√¢ble <span>60 Fe, 40 Cu</span></button>
    <button class="build-btn" id="btn-battery_factory" onclick="setMode('battery_factory')">üîã Batterie <span>150 Fe, 50 Cu</span></button>
    <button class="build-btn" id="btn-robot_factory" onclick="setMode('robot_factory')">ü§ñ Robot <span>200 Fe, 100 Gls</span></button>
    <button class="build-btn" id="btn-rocket_factory" onclick="setMode('rocket_factory')">üöÄ Fus√©e <span>500 Fe, 200 Mot</span></button>
    <button class="build-btn" id="btn-recycle" onclick="setMode('recycle')" style="color:var(--danger)">‚ôªÔ∏è SUPPR</button>
</div>

<div id="hud">
    <div class="res-grid" id="res-display"></div>
    <div id="power-bar">‚ö° <span id="p-cons">0</span>W / <span id="p-prod">0</span>W</div>
</div>

<div id="viewport"><div id="grid"></div></div>

<div id="tech-tree">
    <h3 style="border-bottom: 1px solid #444">üöÄ Tiers</h3>
    <div id="tier-list"></div>
</div>

<script>
    let state = {
        res: { iron: 500, copper: 200, quartz: 100, glass: 0, motor: 0, cable: 0, battery: 0, robot: 0, rocket: 0, oil: 0 },
        tier: 1, mode: null, offset: { x: 0, y: 0 }, time: 0
    };

    const COLS = 45, ROWS = 22;
    const COSTS = { 
        miner: { iron: 50 }, solar: { iron: 40, copper: 20 },
        glass_factory: { iron: 80, quartz: 40 }, motor_factory: { iron: 120, copper: 60 }, cable_factory: { iron: 60, copper: 40 },
        battery_factory: { iron: 150, copper: 50 }, robot_factory: { iron: 200, glass: 100 }, rocket_factory: { iron: 500, motor: 200 }
    };

    let gridData = [];

    function init() {
        const gridEl = document.getElementById('grid');
        for (let i = 0; i < COLS * ROWS; i++) {
            let r = Math.random();
            let type = (r > 0.96) ? 'quartz' : (r > 0.92) ? 'copper' : (r > 0.88) ? 'iron' : 'empty';
            gridData.push({ id: i, type, build: null, deadUntil: 0 });
            let cell = document.createElement('div');
            cell.className = `cell ${type}`; cell.id = 'c-' + i;
            cell.onclick = () => handleCellClick(i);
            gridEl.appendChild(cell);
        }
        setInterval(spawnMeteor, 120000); // M√©t√©ore toutes les 2 minutes
    }

    function spawnMeteor() {
        document.getElementById('alert').style.display = 'block';
        setTimeout(() => {
            document.getElementById('alert').style.display = 'none';
            const centerIdx = Math.floor(Math.random() * (COLS * ROWS));
            const count = Math.floor(Math.random() * 3) + 1; // 1 √† 3 cases
            
            let targets = [centerIdx];
            // Ajouter des voisins al√©atoires
            for(let i=0; i < count-1; i++) {
                targets.push(centerIdx + (Math.random() > 0.5 ? 1 : -1) * (Math.random() > 0.5 ? 1 : COLS));
            }

            targets.forEach(idx => {
                if(gridData[idx]) {
                    gridData[idx].build = null; // Destruction !
                    gridData[idx].deadUntil = Date.now() + 30000; // 30 secondes
                    updateCellUI(idx);
                }
            });
        }, 3000);
    }

    function handleCellClick(i) {
        if(Date.now() < gridData[i].deadUntil) return; // Case morte
        let cell = gridData[i];
        if (state.mode === 'recycle' && cell.build) { cell.build = null; updateCellUI(i); return; }
        if (cell.build || !state.mode) return;
        let cost = COSTS[state.mode];
        if (cost && Object.keys(cost).every(r => state.res[r] >= cost[r])) {
            Object.keys(cost).forEach(r => state.res[r] -= cost[r]);
            cell.build = state.mode; updateCellUI(i);
        }
    }

    function updateCellUI(i) {
        let c = gridData[i], el = document.getElementById('c-' + i);
        const isDead = Date.now() < c.deadUntil;
        el.className = `cell ${c.type} ${isDead ? 'impact' : ''}`;
        if (c.build) {
            const icons = { miner: '‚õèÔ∏è', solar: '‚òÄÔ∏è', glass_factory: 'üè∫', motor_factory: '‚öôÔ∏è', cable_factory: 'üîå', battery_factory: 'üîã', robot_factory: 'ü§ñ', rocket_factory: 'üöÄ' };
            el.innerHTML = icons[c.build];
        } else el.innerHTML = isDead ? 'üî•' : "";
    }

    // Boucle de prod (simplifi√©e pour l'espace)
    setInterval(() => {
        let curPower = gridData.filter(c => c.build === 'solar').length * 15;
        let powerReq = 0;
        
        gridData.forEach((c, idx) => {
            if(Date.now() < c.deadUntil) { updateCellUI(idx); return; }
            if(!c.build) return;
            // Logique de consommation (Fer=2, Cu=1, Cab=1 -> Bat) etc...
            // [Code de production identique au pr√©c√©dent...]
            if(c.build === 'miner') { powerReq += 8; if(curPower >= powerReq) state.res[c.type] += 1; }
            // Simulation rapide des usines pour l'exemple
            if(c.build.includes('factory')) powerReq += 20;
        });

        // Update HUD
        const resDiv = document.getElementById('res-display');
        resDiv.innerHTML = Object.entries(state.res).map(([k,v]) => `<div class="res-item">${k.slice(0,2)}: ${Math.floor(v)}</div>`).join('');
        document.getElementById('p-cons').innerText = powerReq;
        document.getElementById('p-prod').innerText = curPower;
    }, 1000);

    // Camera drag
    let isDragging = false, lastMouse = { x: 0, y: 0 };
    window.onpointerdown = (e) => { if(e.target.id === 'viewport' || e.target.className.includes('cell')) isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; };
    window.onpointerup = () => isDragging = false;
    window.onpointermove = (e) => {
        if (!isDragging) return;
        state.offset.x += e.clientX - lastMouse.x; state.offset.y += e.clientY - lastMouse.y;
        document.getElementById('grid').style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
        lastMouse = { x: e.clientX, y: e.clientY };
    };
    init();
</script>
</body>
</html>
