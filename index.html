<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dynasties Duel - IA 3 niveaux</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 10px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      gap: 12px;
    }

    #difficultySelect {
      background: #111827;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 4px 8px;
      font-size: 12px;
    }

    #game {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      box-sizing: border-box;
    }

    #board {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      width: 100%;
      max-width: 480px;
      margin-top: 8px;
    }

    .row {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .card {
      width: 70px;
      height: 100px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #111827;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 4px;
      box-sizing: border-box;
      font-size: 10px;
      cursor: pointer;
      position: relative;
      transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
    }

    .card.blocked {
      opacity: 0.3;
      cursor: default;
    }

    .card.selected {
      border-color: #facc15;
      box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4);
      transform: translateY(-2px);
    }

    .card-type {
      font-weight: bold;
      font-size: 9px;
      text-transform: uppercase;
    }

    .card-name {
      font-size: 11px;
      font-weight: 600;
    }

    .card-cost,
    .card-effect {
      font-size: 9px;
      color: #9ca3af;
    }

    #panels {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .playerPanel {
      padding: 8px;
      box-sizing: border-box;
      border-top: 1px solid #1f2937;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .panelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 600;
    }

    .panelHeader span.role {
      font-size: 11px;
      color: #9ca3af;
    }

    .resources {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .resources div {
      min-width: 80px;
    }

    #actions {
      display: flex;
      gap: 8px;
    }

    button {
      flex: 1;
      padding: 8px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #1d4ed8;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    #log {
      font-size: 11px;
      color: #9ca3af;
      max-height: 80px;
      overflow-y: auto;
      border-top: 1px solid #1f2937;
      padding-top: 4px;
    }

    #cardDetails {
      font-size: 11px;
      color: #e5e7eb;
      min-height: 32px;
    }

    #turnInfo {
      font-size: 12px;
      font-weight: 600;
    }

    .militaryTrack {
      width: 100%;
      max-width: 480px;
      margin-top: 4px;
      font-size: 10px;
      color: #9ca3af;
    }

    .militaryBar {
      height: 6px;
      background: #111827;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 2px;
    }

    .militaryMarker {
      height: 100%;
      width: 50%;
      background: linear-gradient(90deg, #22c55e, #ef4444);
      transform-origin: left center;
      transition: transform 0.2s;
    }
  </style>
</head>
<body>
  <header>
    <div>Dynasties Duel — Prototype Âge I</div>
    <div style="display:flex;align-items:center;gap:6px;">
      <label for="difficultySelect" style="font-size:12px;">IA :</label>
      <select id="difficultySelect">
        <option value="easy">Facile</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Expert</option>
      </select>
    </div>
    <div id="turnInfo">Tour du joueur</div>
  </header>

  <div id="game">
    <div id="board"></div>

    <div class="militaryTrack">
      Piste militaire (Joueur ← 0 → IA)
      <div class="militaryBar">
        <div id="militaryMarker" class="militaryMarker"></div>
      </div>
    </div>

    <div id="panels">
      <div class="playerPanel" id="humanPanel">
        <div class="panelHeader">
          <div>Joueur</div>
          <span class="role">Humain</span>
        </div>
        <div id="humanResources" class="resources"></div>
        <div id="cardDetails">Sélectionne une carte accessible.</div>
        <div id="actions">
          <button id="buildBtn" disabled>Construire</button>
          <button id="discardBtn" class="secondary" disabled>Défausser (+2 or)</button>
        </div>
      </div>

      <div class="playerPanel" id="aiPanel">
        <div class="panelHeader">
          <div>Adversaire</div>
          <span class="role">IA</span>
        </div>
        <div id="aiResources" class="resources"></div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Données de base ---

    const cardsAge1 = [
      // Ligne du bas (3 cartes)
      {
        id: "wood_camp",
        name: "Camp de bois",
        age: 1,
        type: "ressource",
        cost: { gold: 0 },
        effect: { wood: 1 }
      },
      {
        id: "clay_pit",
        name: "Fosse d'argile",
        age: 1,
        type: "ressource",
        cost: { gold: 0 },
        effect: { clay: 1 }
      },
      {
        id: "stone_quarry",
        name: "Carrière",
        age: 1,
        type: "ressource",
        cost: { gold: 0 },
        effect: { stone: 1 }
      },

      // Ligne du milieu (2 cartes)
      {
        id: "barracks",
        name: "Caserne",
        age: 1,
        type: "militaire",
        cost: { clay: 1 },
        effect: { military: 1 }
      },
      {
        id: "library",
        name: "Bibliothèque",
        age: 1,
        type: "science",
        cost: { wood: 1 },
        effect: { science: "compas" }
      },

      // Ligne du haut (1 carte)
      {
        id: "temple",
        name: "Temple",
        age: 1,
        type: "civique",
        cost: { stone: 1 },
        effect: { victory: 3 }
      }
    ];

    const pyramidLayout = [
      [5],
      [3, 4],
      [0, 1, 2]
    ];

    // --- État du jeu ---

    const human = {
      name: "Joueur",
      gold: 6,
      wood: 0,
      clay: 0,
      stone: 0,
      military: 0,
      science: [],
      victory: 0
    };

    const ai = {
      name: "IA",
      gold: 6,
      wood: 0,
      clay: 0,
      stone: 0,
      military: 0,
      science: [],
      victory: 0,
      strategy: "balanced" // "military", "science", "balanced"
    };

    const gameState = {
      currentPlayer: "human", // "human" ou "ai"
      difficulty: "normal",
      militaryTrack: 0, // -6 (IA gagne) à +6 (Humain gagne)
      finished: false
    };

    const boardState = {
      cards: cardsAge1.map((card, index) => ({
        index,
        taken: false
      }))
    };

    let selectedCardIndex = null;

    // --- Utilitaires généraux ---

    function log(message) {
      const logDiv = document.getElementById("log");
      const line = document.createElement("div");
      line.textContent = message;
      logDiv.prepend(line);
    }

    function canAfford(player, cost) {
      if (!cost) return true;
      if (cost.gold && player.gold < cost.gold) return false;
      if (cost.wood && player.wood < cost.wood) return false;
      if (cost.clay && player.clay < cost.clay) return false;
      if (cost.stone && player.stone < cost.stone) return false;
      return true;
    }

    function payCost(player, cost) {
      if (!cost) return;
      if (cost.gold) player.gold -= cost.gold;
      if (cost.wood) player.wood -= cost.wood;
      if (cost.clay) player.clay -= cost.clay;
      if (cost.stone) player.stone -= cost.stone;
    }

    function applyEffect(player, effect) {
      if (!effect) return;
      if (effect.gold) player.gold += effect.gold;
      if (effect.wood) player.wood += effect.wood;
      if (effect.clay) player.clay += effect.clay;
      if (effect.stone) player.stone += effect.stone;
      if (effect.military) {
        player.military += effect.military;
        if (player === human) {
          gameState.militaryTrack += effect.military;
        } else {
          gameState.militaryTrack -= effect.military;
        }
        updateMilitaryUI();
        checkMilitaryVictory();
      }
      if (effect.victory) player.victory += effect.victory;
      if (effect.science) player.science.push(effect.science);
    }

    function formatCost(cost) {
      if (!cost) return "0";
      const parts = [];
      if (cost.gold) parts.push(cost.gold + " or");
      if (cost.wood) parts.push(cost.wood + " bois");
      if (cost.clay) parts.push(cost.clay + " argile");
      if (cost.stone) parts.push(cost.stone + " pierre");
      return parts.join(", ") || "0";
    }

    function formatEffect(effect) {
      if (!effect) return "—";
      const parts = [];
      if (effect.gold) parts.push("+" + effect.gold + " or");
      if (effect.wood) parts.push("+" + effect.wood + " bois");
      if (effect.clay) parts.push("+" + effect.clay + " argile");
      if (effect.stone) parts.push("+" + effect.stone + " pierre");
      if (effect.military) parts.push("+" + effect.military + " militaire");
      if (effect.victory) parts.push("+" + effect.victory + " PV");
      if (effect.science) parts.push("science: " + effect.science);
      return parts.join(", ") || "—";
    }

    function isCardBlocked(rowIndex, colIndex) {
      if (rowIndex === 0) return false;
      const aboveRow = pyramidLayout[rowIndex - 1];
      const currentRow = pyramidLayout[rowIndex];

      let blockers = [];
      if (rowIndex === 2) {
        if (colIndex === 0) blockers = [aboveRow[0]];
        if (colIndex === 1) blockers = [aboveRow[0], aboveRow[1]];
        if (colIndex === 2) blockers = [aboveRow[1]];
      } else if (rowIndex === 1) {
        if (colIndex === 0) blockers = [aboveRow[0]];
        if (colIndex === 1) blockers = [aboveRow[0]];
      }

      for (const idx of blockers) {
        const state = boardState.cards[idx];
        if (!state.taken) return true;
      }
      return false;
    }

    function getAccessibleCards() {
      const result = [];
      pyramidLayout.forEach((row, rowIndex) => {
        row.forEach((cardIndex, colIndex) => {
          const state = boardState.cards[cardIndex];
          if (state.taken) return;
          const blocked = isCardBlocked(rowIndex, colIndex);
          if (!blocked) {
            result.push(cardsAge1[cardIndex]);
          }
        });
      });
      return result;
    }

    // --- UI ---

    function updateResourcesUI() {
      const humanDiv = document.getElementById("humanResources");
      humanDiv.innerHTML = `
        <div><strong>Or :</strong> ${human.gold}</div>
        <div><strong>Bois :</strong> ${human.wood}</div>
        <div><strong>Argile :</strong> ${human.clay}</div>
        <div><strong>Pierre :</strong> ${human.stone}</div>
        <div><strong>Militaire :</strong> ${human.military}</div>
        <div><strong>Victoire :</strong> ${human.victory}</div>
      `;

      const aiDiv = document.getElementById("aiResources");
      aiDiv.innerHTML = `
        <div><strong>Or :</strong> ${ai.gold}</div>
        <div><strong>Bois :</strong> ${ai.wood}</div>
        <div><strong>Argile :</strong> ${ai.clay}</div>
        <div><strong>Pierre :</strong> ${ai.stone}</div>
        <div><strong>Militaire :</strong> ${ai.military}</div>
        <div><strong>Victoire :</strong> ${ai.victory}</div>
      `;
    }

    function updateMilitaryUI() {
      const marker = document.getElementById("militaryMarker");
      // gameState.militaryTrack va de -6 à +6
      const t = (gameState.militaryTrack + 6) / 12; // 0 à 1
      marker.style.transform = `scaleX(${t})`;
    }

    function updateTurnInfo() {
      const turnInfo = document.getElementById("turnInfo");
      if (gameState.finished) {
        turnInfo.textContent = "Partie terminée";
      } else if (gameState.currentPlayer === "human") {
        turnInfo.textContent = "Tour du joueur";
      } else {
        turnInfo.textContent = "Tour de l'IA";
      }
    }

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";

      pyramidLayout.forEach((row, rowIndex) => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "row";

        row.forEach((cardIndex, colIndex) => {
          const cardData = cardsAge1[cardIndex];
          const state = boardState.cards[cardIndex];

          const cardDiv = document.createElement("div");
          cardDiv.className = "card";

          if (state.taken) {
            cardDiv.style.visibility = "hidden";
          } else {
            const blocked = isCardBlocked(rowIndex, colIndex);
            if (blocked) cardDiv.classList.add("blocked");

            cardDiv.dataset.index = cardIndex;

            const typeDiv = document.createElement("div");
            typeDiv.className = "card-type";
            typeDiv.textContent = cardData.type;

            const nameDiv = document.createElement("div");
            nameDiv.className = "card-name";
            nameDiv.textContent = cardData.name;

            const costDiv = document.createElement("div");
            costDiv.className = "card-cost";
            costDiv.textContent = "Coût: " + formatCost(cardData.cost);

            const effectDiv = document.createElement("div");
            effectDiv.className = "card-effect";
            effectDiv.textContent = "Effet: " + formatEffect(cardData.effect);

            cardDiv.appendChild(typeDiv);
            cardDiv.appendChild(nameDiv);
            cardDiv.appendChild(costDiv);
            cardDiv.appendChild(effectDiv);

            cardDiv.addEventListener("click", () => {
              if (gameState.currentPlayer !== "human") return;
              if (blocked) return;
              selectCard(cardIndex);
            });

            if (selectedCardIndex === cardIndex) {
              cardDiv.classList.add("selected");
            }
          }

          rowDiv.appendChild(cardDiv);
        });

        boardDiv.appendChild(rowDiv);
      });
    }

    function selectCard(index) {
      selectedCardIndex = index;
      const card = cardsAge1[index];
      const detailsDiv = document.getElementById("cardDetails");
      detailsDiv.textContent =
        `${card.name} — Type: ${card.type} — Coût: ${formatCost(card.cost)} — Effet: ${formatEffect(card.effect)}`;

      const canBuild = canAfford(human, card.cost);
      document.getElementById("buildBtn").disabled = !canBuild || gameState.finished;
      document.getElementById("discardBtn").disabled = gameState.finished;

      renderBoard();
    }

    // --- Fin de partie ---

    function checkEndOfBoard() {
      const remaining = boardState.cards.some(c => !c.taken);
      if (!remaining && !gameState.finished) {
        // Fin de l'âge I -> on calcule un vainqueur simple
        let winner = null;
        const humanScore = human.victory + human.military + human.science.length;
        const aiScore = ai.victory + ai.military + ai.science.length;

        if (humanScore > aiScore) winner = "Humain";
        else if (aiScore > humanScore) winner = "IA";
        else winner = "Égalité";

        log(`Fin de l'âge I. Score Joueur: ${humanScore}, IA: ${aiScore}. Résultat: ${winner}.`);
        gameState.finished = true;
        updateTurnInfo();
        document.getElementById("buildBtn").disabled = true;
        document.getElementById("discardBtn").disabled = true;
      }
    }

    function checkMilitaryVictory() {
      if (gameState.militaryTrack >= 6 && !gameState.finished) {
        log("Victoire militaire du Joueur !");
        gameState.finished = true;
        updateTurnInfo();
      } else if (gameState.militaryTrack <= -6 && !gameState.finished) {
        log("Victoire militaire de l'IA !");
        gameState.finished = true;
        updateTurnInfo();
      }
    }

    // --- IA ---

    function setDifficulty(diff) {
      gameState.difficulty = diff;
      if (diff === "easy") {
        ai.strategy = "balanced";
      } else if (diff === "normal") {
        ai.strategy = "military";
      } else {
        ai.strategy = "science";
      }
    }

    function evaluateCardForAI(card) {
      let score = 0;

      // Valeur de base
      if (card.type === "ressource") score += 2;
      if (card.type === "militaire") score += 3;
      if (card.type === "science") score += 4;
      if (card.type === "civique") score += (card.effect.victory || 1);

      // Stratégie
      if (ai.strategy === "military" && card.type === "militaire") score += 3;
      if (ai.strategy === "science" && card.type === "science") score += 3;

      // Danger pour le joueur (un peu de “blocage”)
      if (card.type === "science") score += 1;
      if (card.type === "militaire") score += 1;

      // Coût
      if (!canAfford(ai, card.cost)) score -= 1000;

      // Ajustement selon difficulté
      if (gameState.difficulty === "easy") {
        // IA un peu plus bête : bruit aléatoire
        score += (Math.random() * 2 - 1); // -1 à +1
      } else if (gameState.difficulty === "hard") {
        // IA plus “fine” : bonus si carte utile au joueur
        if (card.type === "science" || card.type === "militaire") {
          score += 2;
        }
      }

      return score;
    }

    function aiChooseCard() {
      const accessible = getAccessibleCards();
      if (accessible.length === 0) return null;

      let bestCard = null;
      let bestScore = -Infinity;

      for (const card of accessible) {
        const score = evaluateCardForAI(card);
        if (score > bestScore) {
          bestScore = score;
          bestCard = card;
        }
      }

      return bestCard;
    }

    function aiPlayTurn() {
      if (gameState.finished) return;

      updateTurnInfo();
      setTimeout(() => {
        const card = aiChooseCard();
        if (!card) {
          log("L'IA ne peut jouer aucune carte.");
          gameState.currentPlayer = "human";
          updateTurnInfo();
          return;
        }

        const state = boardState.cards[card.index];

        if (canAfford(ai, card.cost)) {
          payCost(ai, card.cost);
          applyEffect(ai, card.effect);
          state.taken = true;
          log(`L'IA construit ${card.name}.`);
        } else {
          ai.gold += 2;
          state.taken = true;
          log(`L'IA défausse ${card.name} et gagne 2 or.`);
        }

        updateResourcesUI();
        renderBoard();
        checkEndOfBoard();

        if (!gameState.finished) {
          gameState.currentPlayer = "human";
          updateTurnInfo();
        }
      }, 600);
    }

    // --- Actions Joueur ---

    function buildSelectedCard() {
      if (selectedCardIndex === null || gameState.currentPlayer !== "human" || gameState.finished) return;
      const card = cardsAge1[selectedCardIndex];
      const state = boardState.cards[selectedCardIndex];
      if (state.taken) return;
      if (!canAfford(human, card.cost)) {
        log("Tu ne peux pas payer cette carte.");
        return;
      }
      payCost(human, card.cost);
      applyEffect(human, card.effect);
      state.taken = true;
      log(`Tu construis ${card.name}.`);
      selectedCardIndex = null;
      document.getElementById("cardDetails").textContent = "Sélectionne une carte accessible.";
      document.getElementById("buildBtn").disabled = true;
      document.getElementById("discardBtn").disabled = true;
      updateResourcesUI();
      renderBoard();
      checkEndOfBoard();

      if (!gameState.finished) {
        gameState.currentPlayer = "ai";
        updateTurnInfo();
        aiPlayTurn();
      }
    }

    function discardSelectedCard() {
      if (selectedCardIndex === null || gameState.currentPlayer !== "human" || gameState.finished) return;
      const card = cardsAge1[selectedCardIndex];
      const state = boardState.cards[selectedCardIndex];
      if (state.taken) return;
      human.gold += 2;
      state.taken = true;
      log(`Tu défausses ${card.name} et gagnes 2 or.`);
      selectedCardIndex = null;
      document.getElementById("cardDetails").textContent = "Sélectionne une carte accessible.";
      document.getElementById("buildBtn").disabled = true;
      document.getElementById("discardBtn").disabled = true;
      updateResourcesUI();
      renderBoard();
      checkEndOfBoard();

      if (!gameState.finished) {
        gameState.currentPlayer = "ai";
        updateTurnInfo();
        aiPlayTurn();
      }
    }

    // --- Initialisation ---

    function init() {
      document.getElementById("buildBtn").addEventListener("click", buildSelectedCard);
      document.getElementById("discardBtn").addEventListener("click", discardSelectedCard);

      document.getElementById("difficultySelect").addEventListener("change", (e) => {
        setDifficulty(e.target.value);
        log(`Difficulté IA : ${e.target.options[e.target.selectedIndex].text}`);
      });

      setDifficulty("normal");
      updateResourcesUI();
      updateMilitaryUI();
      updateTurnInfo();
      renderBoard();
      log("Bienvenue dans le prototype. Tu joues contre une IA à 3 niveaux de difficulté.");
    }

    init();
  </script>
</body>
</html>
