<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Planet - Pro Power</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #ff9800; --iron: #9e9e9e; --copper: #d84315; --quartz: #00e5ff; --power: #4caf50; --danger: #f44336; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; }
        
        /* HUD AM√âLIOR√â */
        #hud { position: fixed; top: 0; width: 100%; background: var(--panel); z-index: 100; padding: 10px; border-bottom: 2px solid #333; box-sizing: border-box; display: grid; grid-template-columns: 1fr 1fr; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; }
        .res-item { display: flex; align-items: center; gap: 4px; }
        
        /* AFFICHAGE √âLECTRIQUE CHIFFR√â */
        #power-display { font-size: 13px; font-weight: bold; padding: 5px; border-radius: 4px; background: #000; display: inline-block; margin-top: 5px; }
        .p-normal { color: var(--power); }
        .p-alert { color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #viewport { width: 100vw; height: 100vh; overflow: hidden; background: #0a0a0a; display: flex; align-items: center; justify-content: center; }
        #grid { display: grid; grid-template-columns: repeat(20, 45px); grid-template-rows: repeat(20, 45px); gap: 2px; }

        .cell { width: 45px; height: 45px; background: #1a1a1a; border: 1px solid #252525; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .cell.iron { border-bottom: 3px solid var(--iron); }
        .cell.copper { border-bottom: 3px solid var(--copper); }
        .cell.quartz { border-bottom: 3px solid var(--quartz); }
        .cell.occupied { background: #333; }
        
        #controls { position: fixed; bottom: 0; width: 100%; background: var(--panel); padding: 12px; display: flex; gap: 8px; overflow-x: auto; border-top: 2px solid #333; z-index: 100; }
        button { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 4px; font-size: 11px; min-width: 80px; }
        button.active { border-color: var(--accent); background: #443311; }
        #upgrade-btn { font-size: 10px; background: #222; border-color: var(--accent); }
    </style>
</head>
<body>

<div id="hud">
    <div class="res-grid">
        <div class="res-item" style="color:var(--iron)">Fe: <span id="res-iron">0</span></div>
        <div class="res-item" style="color:var(--copper)">Cu: <span id="res-copper">0</span></div>
        <div class="res-item" style="color:var(--quartz)">Qz: <span id="res-quartz">0</span></div>
        <div id="power-display" class="p-normal">
            ‚ö° <span id="p-cons">0</span>W / <span id="p-prod">0</span>W
        </div>
    </div>
    <div style="text-align: right;">
        <div id="tier-display" style="color:var(--accent); font-size:12px; margin-bottom:5px;">TIER 1</div>
        <button id="upgrade-btn" onclick="upgradeTier()">Upgrade</button>
        <button onclick="resetGame()" style="font-size:8px; padding:2px; min-width:40px; margin-top:5px; border:none; background:none; color:#555;">Reset</button>
    </div>
</div>

<div id="viewport">
    <div id="grid"></div>
</div>

<div id="controls">
    <button id="btn-miner" onclick="setMode('miner')">‚õèÔ∏è Mineur<br>(50 Fe)</button>
    <button id="btn-solar" onclick="setMode('solar')">‚òÄÔ∏è Solaire<br>(40 Fe, 20 Cu)</button>
    <button id="btn-battery" onclick="setMode('battery')">üîã Bat<br>(100 Fe)</button>
</div>

<script>
    let state = {
        res: { iron: 100, copper: 50, quartz: 0 },
        tier: 1, mode: null, offset: { x: 0, y: 0 }
    };

    let gridData = [];
    const GRID_SIZE = 20;

    // --- LOGIQUE DE SAUVEGARDE ---
    function saveGame() {
        const saveData = { state, gridData };
        localStorage.setItem('factorySave_v1', JSON.stringify(saveData));
    }

    function loadGame() {
        const saved = localStorage.getItem('factorySave_v1');
        if (saved) {
            const parsed = JSON.parse(saved);
            state = parsed.state;
            gridData = parsed.gridData;
            return true;
        }
        return false;
    }

    function resetGame() {
        if(confirm("R√©initialiser toute la plan√®te ?")) {
            localStorage.removeItem('factorySave_v1');
            location.reload();
        }
    }

    // --- INITIALISATION ---
    function init() {
        const gridEl = document.getElementById('grid');
        const hasSave = loadGame();

        if (!hasSave) {
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                let r = Math.random();
                let type = 'empty';
                if (r > 0.97) type = 'quartz';
                else if (r > 0.92) type = 'copper';
                else if (r > 0.85) type = 'iron';
                gridData.push({ id: i, type: type, build: null, stock: 2000 });
            }
        }

        gridData.forEach((c, i) => {
            let cell = document.createElement('div');
            cell.className = `cell ${c.type}`;
            cell.id = 'c-' + i;
            cell.onclick = () => handleCellClick(i);
            gridEl.appendChild(cell);
            updateCellUI(i);
        });
        
        document.getElementById('tier-display').innerText = "TIER " + state.tier;
    }

    function setMode(m) {
        state.mode = (state.mode === m) ? null : m;
        document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
        if(state.mode) document.getElementById('btn-' + m).classList.add('active');
    }

    function handleCellClick(i) {
        let cell = gridData[i];
        if (cell.build) return;

        if (state.mode === 'miner' && state.res.iron >= 50 && cell.type !== 'empty') {
            state.res.iron -= 50; cell.build = 'miner';
        } else if (state.mode === 'solar' && state.res.iron >= 40 && state.res.copper >= 20) {
            state.res.iron -= 40; state.res.copper -= 20; cell.build = 'solar';
        }
        updateCellUI(i);
        saveGame();
    }

    function updateCellUI(i) {
        let c = gridData[i];
        let el = document.getElementById('c-' + i);
        if (c.build) {
            el.classList.add('occupied');
            el.innerHTML = c.build === 'miner' ? '‚õèÔ∏è' : (c.build === 'solar' ? '‚òÄÔ∏è' : 'üîã');
        } else {
            el.innerHTML = "";
            el.classList.remove('occupied');
        }
    }

    function upgradeTier() {
        let cost = state.tier * 500;
        if (state.res.iron >= cost && state.res.copper >= cost / 2 && state.res.quartz >= cost / 5) {
            state.res.iron -= cost; state.res.copper -= cost / 2; state.res.quartz -= cost / 5;
            state.tier++;
            document.getElementById('tier-display').innerText = "TIER " + state.tier;
            saveGame();
        }
    }

    // --- BOUCLE DE JEU ---
    setInterval(() => {
        let miners = gridData.filter(c => c.build === 'miner');
        let prodW = gridData.filter(c => c.build === 'solar').length * (10 * state.tier);
        let consW = miners.length * 5;
        let efficiency = prodW >= consW ? 1 : (prodW / (consW || 1));

        miners.forEach(m => {
            if (m.stock > 0) {
                let qty = (0.5 * state.tier) * efficiency;
                state.res[m.type] += qty;
                m.stock -= qty;
            }
        });

        // Mise √† jour HUD
        document.getElementById('res-iron').innerText = Math.floor(state.res.iron);
        document.getElementById('res-copper').innerText = Math.floor(state.res.copper);
        document.getElementById('res-quartz').innerText = Math.floor(state.res.quartz);
        
        const pDisp = document.getElementById('power-display');
        document.getElementById('p-cons').innerText = consW;
        document.getElementById('p-prod').innerText = prodW;

        if (efficiency < 1) {
            pDisp.className = 'p-alert';
        } else {
            pDisp.className = 'p-normal';
        }
        
        let upCost = state.tier * 500;
        document.getElementById('upgrade-btn').innerText = `UP T${state.tier+1} (${upCost} Fe/Cu)`;
        document.getElementById('upgrade-btn').disabled = state.res.iron < upCost;
    }, 1000);

    // Sauvegarde auto toutes les 10 sec
    setInterval(saveGame, 10000);

    // Navigation Drag
    let isDragging = false;
    let lastMouse = { x: 0, y: 0 };
    const viewport = document.getElementById('viewport');
    const grid = document.getElementById('grid');

    viewport.onpointerdown = (e) => { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; };
    window.onpointerup = () => isDragging = false;
    window.onpointermove = (e) => {
        if (!isDragging) return;
        state.offset.x += e.clientX - lastMouse.x;
        state.offset.y += e.clientY - lastMouse.y;
        grid.style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
        lastMouse = { x: e.clientX, y: e.clientY };
    };

    init();
</script>
</body>
</html>
