<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Planet 20x20</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #ff9800; --blue: #2196f3; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; }
        
        /* HUD */
        #hud { position: fixed; top: 0; width: 100%; background: var(--panel); z-index: 100; padding: 10px; display: flex; justify-content: space-between; border-bottom: 2px solid #333; box-sizing: border-box; }
        .stat { font-size: 14px; margin-bottom: 5px; }
        #tier-display { color: var(--accent); font-weight: bold; }

        /* Conteneur Grille (Zoomable) */
        #viewport { width: 100vw; height: 100vh; overflow: hidden; cursor: grab; background: #0a0a0a; display: flex; align-items: center; justify-content: center; }
        #grid { 
            display: grid; 
            grid-template-columns: repeat(20, 40px); 
            grid-template-rows: repeat(20, 40px); 
            gap: 2px; 
            transform-origin: center;
        }

        .cell { width: 40px; height: 40px; background: #1a1a1a; border: 1px solid #252525; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .cell.iron { background: #2a2a2a; color: #777; border-color: #444; }
        .cell.occupied { background: #333; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        
        /* Menu de construction */
        #controls { position: fixed; bottom: 0; width: 100%; background: var(--panel); padding: 15px; display: flex; gap: 10px; overflow-x: auto; border-top: 2px solid #333; z-index: 100; }
        button { background: #333; color: white; border: 1px solid #555; padding: 10px 15px; border-radius: 4px; white-space: nowrap; }
        button.active { border-color: var(--accent); background: #443311; }
        button:disabled { opacity: 0.3; }

        /* Power Bar */
        .p-bar { width: 80px; height: 8px; background: #000; display: inline-block; vertical-align: middle; }
        #p-fill { height: 100%; background: #4caf50; width: 0%; transition: 0.3s; }
    </style>
</head>
<body>

<div id="hud">
    <div>
        <div class="stat">üì¶ <span id="res-iron">0</span> Iron</div>
        <div class="stat">‚ö° <div class="p-bar"><div id="p-fill"></div></div></div>
    </div>
    <div style="text-align: right;">
        <div id="tier-display">TIER 1</div>
        <button id="upgrade-btn" onclick="upgradeTier()">Upgrade (1000 Fe)</button>
    </div>
</div>

<div id="viewport" id="v-port">
    <div id="grid"></div>
</div>

<div id="controls">
    <button id="btn-miner" onclick="setMode('miner')">‚õèÔ∏è Mineur (50)</button>
    <button id="btn-solar" onclick="setMode('solar')">‚òÄÔ∏è Solaire (30)</button>
    <button id="btn-battery" onclick="setMode('battery')">üîã Batterie (100)</button>
</div>

<script>
    let state = {
        iron: 100,
        tier: 1,
        mode: null,
        offset: { x: 0, y: 0 },
        isDragging: false,
        lastMouse: { x: 0, y: 0 }
    };

    let gridData = [];
    const GRID_SIZE = 20;

    // Cr√©ation de la grille
    const gridEl = document.getElementById('grid');
    for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
        let isIron = Math.random() > 0.92;
        gridData.push({ id: i, type: isIron ? 'iron' : 'empty', build: null, stock: 1000 });
        let cell = document.createElement('div');
        cell.className = 'cell' + (isIron ? ' iron' : '');
        cell.id = 'c-' + i;
        cell.onclick = () => handleCellClick(i);
        gridEl.appendChild(cell);
    }

    function setMode(m) {
        state.mode = m;
        document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
        if(m) document.getElementById('btn-' + m).classList.add('active');
    }

    function handleCellClick(i) {
        let cell = gridData[i];
        if (cell.build) return;

        if (state.mode === 'miner' && state.iron >= 50 && cell.type === 'iron') {
            state.iron -= 50; cell.build = 'miner';
        } else if (state.mode === 'solar' && state.iron >= 30) {
            state.iron -= 30; cell.build = 'solar';
        } else if (state.mode === 'battery' && state.iron >= 100) {
            state.iron -= 100; cell.build = 'battery';
        }
        updateCell(i);
    }

    function updateCell(i) {
        let c = gridData[i];
        let el = document.getElementById('c-' + i);
        if (c.build) {
            el.classList.add('occupied');
            el.innerHTML = c.build === 'miner' ? '‚õèÔ∏è' : (c.build === 'solar' ? '‚òÄÔ∏è' : 'üîã');
        }
    }

    function upgradeTier() {
        let cost = state.tier * 1000;
        if (state.iron >= cost) {
            state.iron -= cost;
            state.tier++;
            document.getElementById('tier-display').innerText = "TIER " + state.tier;
            document.getElementById('upgrade-btn').innerText = `Upgrade (${(state.tier) * 1000} Fe)`;
        }
    }

    // Boucle de jeu
    setInterval(() => {
        let miners = gridData.filter(c => c.build === 'miner');
        let solars = gridData.filter(c => c.build === 'solar');
        
        let prod = solars.length * (5 * state.tier);
        let cons = miners.length * 3;
        let efficiency = prod >= cons ? 1 : (prod / (cons || 1));

        miners.forEach(m => {
            if (m.stock > 0) {
                let qty = (0.5 * state.tier) * efficiency;
                state.iron += qty;
                m.stock -= qty;
            }
        });

        document.getElementById('res-iron').innerText = Math.floor(state.iron);
        document.getElementById('p-fill').style.width = (efficiency * 100) + "%";
        document.getElementById('p-fill').style.background = efficiency < 1 ? "#f44336" : "#4caf50";
        document.getElementById('upgrade-btn').disabled = state.iron < (state.tier * 1000);
    }, 1000);

    // Syst√®me de Drag pour Mobile
    const viewport = document.getElementById('viewport');
    viewport.onpointerdown = (e) => { state.isDragging = true; state.lastMouse = { x: e.clientX, y: e.clientY }; };
    window.onpointerup = () => state.isDragging = false;
    window.onpointermove = (e) => {
        if (!state.isDragging) return;
        state.offset.x += e.clientX - state.lastMouse.x;
        state.offset.y += e.clientY - state.lastMouse.y;
        gridEl.style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
        state.lastMouse = { x: e.clientX, y: e.clientY };
    };
</script>
</body>
</html>
