<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Factory Planet - Day/Night Cycle</title>
    <style>
        :root { 
            --bg: #121212; --panel: #1e1e1e; --accent: #ff9800; 
            --iron: #424242; --copper: #6d2d1a; --quartz: #006064; --oil: #000000;
            --power: #4caf50; --danger: #f44336; 
        }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; transition: background 2s; }
        
        /* HUD */
        #hud { position: fixed; top: 0; width: 100%; background: var(--panel); z-index: 100; padding: 10px; border-bottom: 2px solid #333; box-sizing: border-box; display: grid; grid-template-columns: 1.2fr 0.8fr; }
        .res-grid { font-size: 11px; line-height: 1.5; }
        .flux { font-size: 9px; margin-left: 4px; font-weight: bold; }
        .gain { color: #4caf50; }
        .loss { color: #f44336; }
        
        #power-display { font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: #080808; display: inline-block; margin-top: 5px; border: 1px solid #333; }
        .p-normal { color: var(--power); }
        .p-alert { color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Indicateur Cycle */
        #cycle-info { font-size: 14px; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .night-mode { background: #0a0a1a !important; }
        .night-grid { filter: brightness(0.5); }

        #viewport { width: 100vw; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #grid { display: grid; grid-template-columns: repeat(20, 50px); grid-template-rows: repeat(20, 50px); gap: 2px; transition: filter 2s; }

        .cell { width: 50px; height: 50px; background: #1a1a1a; border: 1px solid #252525; display: flex; align-items: center; justify-content: center; font-size: 22px; position: relative; }
        .cell.iron { background-color: var(--iron); }
        .cell.copper { background-color: var(--copper); }
        .cell.quartz { background-color: var(--quartz); }
        .cell.oil { background-color: var(--oil); border: 1px solid #333; }
        
        .no-fuel-icon { position: absolute; font-size: 14px; top: 2px; right: 2px; animation: blink 0.5s infinite; color: var(--danger); }

        #controls { position: fixed; bottom: 0; width: 100%; background: var(--panel); padding: 10px; display: flex; gap: 8px; overflow-x: auto; border-top: 2px solid #333; z-index: 100; }
        button { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; font-size: 10px; min-width: 85px; text-align: center; }
        button.active { border-color: var(--accent); background: #443311; }
        button.recycle-mode { border-color: var(--danger); background: #331111; }
    </style>
</head>
<body>

<div id="hud">
    <div class="res-grid">
        <div id="cycle-info">‚òÄÔ∏è Jour</div>
        <div style="color:#bbb">Fer: <span id="res-iron">0</span> <span id="flux-iron" class="flux"></span></div>
        <div style="color:#ff7043">Cuivre: <span id="res-copper">0</span> <span id="flux-copper" class="flux"></span></div>
        <div style="color:#26c6da">Quartz: <span id="res-quartz">0</span> <span id="flux-quartz" class="flux"></span></div>
        <div style="color:#fff">P√©trole: <span id="res-oil">0</span> <span id="flux-oil" class="flux"></span></div>
        <div id="power-display" class="p-normal">‚ö° <span id="p-cons">0</span>W / <span id="p-prod">0</span>W</div>
    </div>
    <div style="text-align: right;">
        <div id="tier-display" style="color:var(--accent); font-size:12px; margin-bottom:4px;">TIER 1</div>
        <button id="upgrade-btn" onclick="upgradeTier()" style="width:100%">UPGRADE</button>
    </div>
</div>

<div id="viewport">
    <div id="grid"></div>
</div>

<div id="controls">
    <button id="btn-miner" onclick="setMode('miner')">‚õèÔ∏è Mineur<br>50 Fe</button>
    <button id="btn-solar" onclick="setMode('solar')">‚òÄÔ∏è Solaire<br>40 Fe, 20 Cu</button>
    <button id="btn-fuel" onclick="setMode('fuel')">‚ö° G√©n√©rateur<br>150 Fe, 80 Cu</button>
    <button id="btn-recycle" onclick="setMode('recycle')" style="color:var(--danger)">‚ôªÔ∏è Recycler</button>
</div>

<script>
    let state = {
        res: { iron: 150, copper: 80, quartz: 0, oil: 0 },
        tier: 1, mode: null, offset: { x: 0, y: 0 },
        time: 0 // Temps en secondes
    };

    let gridData = [];
    const GRID_SIZE = 20;
    const CYCLE_DURATION = 60; // 30s jour / 30s nuit
    const COSTS = { miner: { iron: 50, copper: 0 }, solar: { iron: 40, copper: 20 }, fuel: { iron: 150, copper: 80 } };

    function saveGame() { localStorage.setItem('factorySave_v6', JSON.stringify({ state, gridData })); }
    function loadGame() {
        const saved = localStorage.getItem('factorySave_v6');
        if (saved) { const p = JSON.parse(saved); state = p.state; gridData = p.gridData; return true; }
        return false;
    }

    function init() {
        const gridEl = document.getElementById('grid');
        if (!loadGame()) {
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                let r = Math.random();
                let type = 'empty';
                if (r > 0.98) type = 'oil'; else if (r > 0.96) type = 'quartz'; else if (r > 0.91) type = 'copper'; else if (r > 0.83) type = 'iron';
                gridData.push({ id: i, type: type, build: null, stock: 5000 });
            }
        }
        gridData.forEach((c, i) => {
            let cell = document.createElement('div');
            cell.className = `cell ${c.type}`;
            cell.id = 'c-' + i;
            cell.onclick = () => handleCellClick(i);
            gridEl.appendChild(cell);
            updateCellUI(i);
        });
        gridEl.style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
    }

    function setMode(m) {
        state.mode = (state.mode === m) ? null : m;
        document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active', 'recycle-mode'));
        if(state.mode) {
            let btn = document.getElementById('btn-' + m);
            btn.classList.add(m === 'recycle' ? 'recycle-mode' : 'active');
        }
    }

    function handleCellClick(i) {
        let cell = gridData[i];
        if (state.mode === 'recycle' && cell.build) {
            state.res.iron += Math.floor(COSTS[cell.build].iron * 0.8);
            state.res.copper += Math.floor(COSTS[cell.build].copper * 0.8);
            cell.build = null; updateCellUI(i); saveGame(); return;
        }
        if (cell.build || !state.mode) return;
        let cost = COSTS[state.mode];
        if (cost && state.res.iron >= cost.iron && state.res.copper >= cost.copper) {
            if (state.mode === 'miner' && cell.type === 'empty') return;
            state.res.iron -= cost.iron; state.res.copper -= cost.copper;
            cell.build = state.mode; updateCellUI(i); saveGame();
        }
    }

    function updateCellUI(i, hasFuel = true) {
        let c = gridData[i], el = document.getElementById('c-' + i);
        if (c.build) {
            const icons = { miner: '‚õèÔ∏è', solar: '‚òÄÔ∏è', fuel: '‚ö°' };
            el.innerHTML = icons[c.build] + (c.build === 'fuel' && !hasFuel ? '<span class="no-fuel-icon">‚ö†Ô∏è</span>' : '');
            el.classList.add('occupied');
        } else { el.innerHTML = ""; el.classList.remove('occupied'); }
    }

    function upgradeTier() {
        let cost = state.tier * 800;
        if (state.res.iron >= cost && state.res.copper >= cost / 2) {
            state.res.iron -= cost; state.res.copper -= cost / 2;
            state.tier++; saveGame();
        }
    }

    setInterval(() => {
        state.time = (state.time + 1) % CYCLE_DURATION;
        const isNight = state.time >= (CYCLE_DURATION / 2);
        
        // UI Cycle Update
        document.body.className = isNight ? 'night-mode' : '';
        document.getElementById('grid').className = isNight ? 'night-grid' : '';
        document.getElementById('cycle-info').innerHTML = isNight ? 'üåô Nuit' : '‚òÄÔ∏è Jour';
        document.getElementById('cycle-info').style.color = isNight ? '#9fa8da' : '#ffeb3b';

        let miners = gridData.filter(c => c.build === 'miner');
        
        // Solaire : -70% de prod la nuit
        let solarEfficiency = isNight ? 0.3 : 1.0;
        let solarProd = gridData.filter(c => c.build === 'solar').length * (15 * state.tier * solarEfficiency);
        
        let fuelGens = gridData.filter(c => c.build === 'fuel');
        let fuelProd = 0;
        let oilCons = 0;

        fuelGens.forEach((g) => {
            let cellIdx = gridData.indexOf(g);
            if (state.res.oil >= 1) {
                state.res.oil -= 1; oilCons++; fuelProd += 30 * state.tier;
                updateCellUI(cellIdx, true);
            } else { updateCellUI(cellIdx, false); }
        });

        let prodW = solarProd + fuelProd;
        let consW = miners.length * 8;
        let eff = prodW >= consW ? 1 : (prodW / (consW || 1));
        
        let gains = { iron: 0, copper: 0, quartz: 0, oil: 0 };
        miners.forEach(m => {
            if (m.stock > 0) {
                let qty = (1 * state.tier) * eff;
                state.res[m.type] += qty; m.stock -= qty;
                gains[m.type] += qty;
            }
        });

        ['iron', 'copper', 'quartz', 'oil'].forEach(r => {
            document.getElementById(`res-${r}`).innerText = Math.floor(state.res[r]);
            let fluxEl = document.getElementById(`flux-${r}`);
            let net = gains[r] - (r === 'oil' ? oilCons : 0);
            fluxEl.innerText = (net >= 0 ? "+" : "") + net.toFixed(1) + "/s";
            fluxEl.className = "flux " + (net >= 0 ? "gain" : "loss");
        });

        document.getElementById('p-cons').innerText = Math.round(consW);
        document.getElementById('p-prod').innerText = Math.round(prodW);
        document.getElementById('power-display').className = eff < 1 ? 'p-alert' : 'p-normal';
        
        let upC = state.tier * 800;
        document.getElementById('upgrade-btn').innerHTML = `UP T${state.tier+1}<br>(${upC} Fe)`;
        document.getElementById('upgrade-btn').disabled = state.res.iron < upC;
        document.getElementById('tier-display').innerText = "TIER " + state.tier;
    }, 1000);

    let isDragging = false, lastMouse = { x: 0, y: 0 };
    const vp = document.getElementById('viewport'), gd = document.getElementById('grid');
    vp.onpointerdown = (e) => { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; };
    window.onpointerup = () => { isDragging = false; saveGame(); };
    window.onpointermove = (e) => {
        if (!isDragging) return;
        state.offset.x += e.clientX - lastMouse.x; state.offset.y += e.clientY - lastMouse.y;
        gd.style.transform = `translate(${state.offset.x}px, ${state.offset.y}px)`;
        lastMouse = { x: e.clientX, y: e.clientY };
    };
    init();
</script>
</body>
</html>
